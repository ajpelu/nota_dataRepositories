---
title: "Compartiendo datos en Ecología: como añadir (¿más?) valor a tus datos"
  
author: Antonio Jesús Pérez-Luque^1^, Andrea Ros Candeira^1^, Francisco Rodríguez-Sánchez^2^ 
  
output:
  word_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 7.5
    highlight: null
    reference_docx: Ecosistemas_template.docx
csl: ecosistemas.csl
bibliography: 
  - references.bib
editor_options: 
  chunk_output_type: console
---


> (1) Laboratorio de Ecología, Instituto Interuniversitario de Investigación del Sistema Tierra (IISTA-CEAMA), Universidad de Granada, Avda. del Mediterráneo s/n, Granada 18006, España.

> (2) COMPLETAR 

> Autor para correspondencia: A. J. Pérez-Luque [ajperez@ugr.es]


# Palabras clave

> publicación de datos; repositorios de datos; data papers; metadatos


# Keywords

> data publishing; data repository; data papers; metadata


```{r knitcitations, echo=FALSE, cache = FALSE}
library(knitcitations)
cleanbib()   
cite_options(citation_format = "pandoc")
```


IDEAS:

* Importancia de depositar los datos en repositorios institucionales o reconocidos por la comunidad científica
* Añadir valor añadido a los conjuntos de datos con la documentación de los mismos (metadatado) y la creación de DataPapers
* Enumerar algunas de las principales herramientas / plataformas / etc para documentación y depósito de datos y metadatos
* Inclusión de esta filosofía dentro del ciclo de Reproducibilidad en Ciencia
* Mostrar un caso de ejemplo con SINFONEVADA 
 

Existen muchos repositorios de datos [@Yan2011]. 



Un ejemplo. 



## Como incluir ejemplos

```{r read_data, eval = FALSE, echo = FALSE}
dataset <- read.csv("mydata.csv")
```

Ajustamos un modelo lineal:

$$
y_{i} = \alpha + \beta*x_{i} 
$$

```{r model, echo = FALSE, eval = FALSE}
model <- lm(y ~ x)
```

Utilizamos R `r citep(citation())` y Rmarkdown `r citep(list(citation("knitr"), citation("rmarkdown")))` para todos nuestros análisis. Para ajustar los modelos mixtos utilizamos `lme4` `r citep(citation("lme4"))`.




# Resultados

Esta sección está dividida en subsecciones.


## Subsección 1

Los árboles de la parcela A fueron más altos que en la parcela B (altura media: `r mean(25, 31, 28)` vs `r mean(13, 19, 16)` m). Y muchos más resultados que se actualizan dinámicamente.


## Subsección 2

Texto.


## Subsección 3

Texto.



# Discusión



## Ejemplo SINFONEVADA





Las plantaciones de pinares presentan menor riqueza de especies y menor diversidad de especies que los bosques naturales de encinar y robledal. Esto se debe, en ambas variables, al menor múmero de especies herbáceas presentes en las plantaciones de pinar [@GomezAparicio2009].  





Para establecer los valores iniciales de riqueza en cada uno de los tipos de cobertura vegetal vamos a analizar los datos de campo procedentes de los inventarios forestales SINFONEVADA [@PerezLuque2014]. Para ello consultaremos este [conjunto de datos](http://www.gbif.org/dataset/db6cd9d7-7be5-4cd0-8b3c-fb6dd7446472) en GBIF donde está documentado. 

El objetivo es ***obtener una tabla de riqueza por ecosistema***. Los pasos que realizaremos son: 

* Estudiar el conjunto de datos. Consultar el identificador único (`uuid`) del dataset: `db6cd9d7-7be5-4cd0-8b3c-fb6dd7446472` 
* Descargar el dataset 
* Obtener los valores de riqueza por ecosistema. Para ello utilizaremos el mapa de ecosistemas generado por el [Observatorio de Cambio Global de Sierra Nevada](www.obsnev.es) [@Bonet2010] 




### Obtener el conjunto de datos 

```{r} 
library("knitcitations")
library("rgbif")
library("rgdal")
library("sp")
library("raster")
library("dplyr")
library("sf")
library("knitr")
```

En primer lugar tenemos que conocer el identificador único del conjunto de datos (UUID, *Universally Unique IDentifier*). En este caso, los datos se encuentran en alojados en GBIF, y se corresponde con el Data-Set key "db6cd9d7-7be5-4cd0-8b3c-fb6dd7446472", que se puede obtener de la pagina web del recurso de datos [https://www.gbif.org/dataset/db6cd9d7-7be5-4cd0-8b3c-fb6dd7446472](https://www.gbif.org/dataset/db6cd9d7-7be5-4cd0-8b3c-fb6dd7446472). 

Seguidamente obtenemos el conjunto de datos y sus metadatos, que coinciden con los metadatos incluidos en el repositorio donde se alojan los datos. 

```{r}
### UUID del conjunto de datos 
sinfo_uuid <- 'db6cd9d7-7be5-4cd0-8b3c-fb6dd7446472'

## Metadatos 
sinfo_meta <- datasets(uuid = sinfo_uuid)
```

Este conjunto de datos contiene un total de `r occ_count(datasetKey=sinfo_uuid)` ocurrencias, que podemos obtener escribiendo 

```{r}
occ_count(datasetKey=sinfo_uuid)
```


Y seguidamente vamos a conseguir una tabla que contenga todas las ocurrencias del conjunto de datos

```{r}
sinfonevada <- occ_data(datasetKey=sinfo_meta$data$key, limit = 8000)
```



### Numero de plots y especies por plot

* Obtendremos el numero de plots (agrupando por localización) 
* Para cada plot calcularemos la riqueza de especies 


```{r, eval=FALSE}
# Get only the fields of interest  
df <- sf$data %>% dplyr::select(decimalLatitude, decimalLongitude, scientificName)

# How many species by plot
richness_loc <- df %>%
  group_by(decimalLatitude, decimalLongitude) %>% 
  count() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column(var='id_plot') %>%
  rename(rich = n)
```

### Riqueza por ecosistemas 

* Analizaremos la riqueza media de los plots por ecosistema
* Obtener los ecosistemas de OBSNEV, que están en este [enlace](https://www.dropbox.com/s/urcbafyczvqv7o1/ecosistemas_sn.zip?dl=0). También se han incluido en la carpeta `/data` del paquete. 


```{r, eval=FALSE}
# Prepare Ecosystems data 
wd <- getwd()

temporalwd <- setwd(tempdir())
unzip('../inst/extdata/ecosistemas_sn.zip', exdir = temporalwd)

eco <- readOGR(dsn=temporalwd, layer = 'ecosistemas', encoding="UTF-8", verbose = TRUE)

# Transform projection
eco_t <- spTransform(eco, CRS("+init=epsg:4326"))
```

Ahora creamos una capa vectorial de puntos para los plots del invetnario forestal, y le asignamos su correspondiente proyección.

```{r, eval=FALSE}
# Create an spatial point dataframe for the plots 
richness_sp <- SpatialPointsDataFrame(richness_loc[,c("decimalLongitude", "decimalLatitude")],
                                      richness_loc)
projection(richness_sp) <-  CRS("+init=epsg:4326")
```

Seguidamente realizamos una intersección entre capas. Estamos interesados en obtener la tipología de ecosistema para cada plot del inventario forestal. 

```{r, eval=FALSE}
# See this example
# https://gis.stackexchange.com/questions/226035/join-spatial-point-data-with-multiple-polygon-data-using-r

# Convert to sf-objects
richness_sp.sf <- st_as_sf(richness_sp)
eco_t.sf <- st_as_sf(eco_t)

# Keep all "meuse.sf", sort by row.names(meuse.sf). Default overlay is "intersects".
aux <- st_join(richness_sp.sf, eco_t.sf[,c('COD_ECOSIS', 'ECOSISTE_1')])

# Convert back to Spatial*
richness_sp_eco <- as(aux, "Spatial")
```

Vamos a reagrupar los ecosistemas 

```{r, eval=FALSE}
aux <- aux %>% mutate(newECO = recode_factor(COD_ECOSIS, 
                                                    `8`="Pine plantations",
                                                    `2`="High-mountain meadows",
                                                    `3`="High-mountain shrubland",
                                                    `5`="Mid-mountain shrubland",
                                                    `1`="Pastures",
                                                    `6`="Aquatic systems", 
                                                    `NA`="NA", 
                                                    .default = 'Natural Forests'))
```


Finalmente computamos los valores de riqueza por ecosistemas y por agregados 

```{r, eval=FALSE}
richSinfo <- aux %>%
  group_by(ECOSISTE_1, COD_ECOSIS) %>%
  summarise(mean = mean(rich),
            sd = sd(rich),
            se = sd/sqrt(length(rich)),
            n = length(rich),
            min = min(rich),
            max = max(rich),
            median = median(rich)) %>%
    as.data.frame() %>%
  dplyr::select(-geometry) 
```

```{r, eval=FALSE}
richSinfo_agg <- aux %>%
  group_by(newECO) %>%
  summarise(mean = mean(rich),
            sd = sd(rich),
            se = sd/sqrt(length(rich)),
            n = length(rich),
            min = min(rich),
            max = max(rich), 
            median = median(rich)) %>%
  as.data.frame() %>%
  dplyr::select(-geometry) 

```



En [@GomezAparicio2009] se analizan el mismo dataset, y se obtienen, tras aplicar los modelos, los siguientes resultados:


```{r, eval=FALSE}
richPot <- data.frame(cbind(
  eco = c('Plantations', 'Quercus ilex forests', 'Natural deciduous forests'),
  n = c(442, 45, 26),
  potRich = c(13.09, 14.92, 17.55),
  lowerInterval = c(12.82, 13.72, 15.62), 
  upperInterval = c(13.34, 16.11, 19.66)))

```














# Conclusiones

Texto.


# Agradecimientos

LIFEADAPTAMED?  
ECOPOTENTIAL? 
Convenio OBSNEV?






###### REFERENCIAS

```{r write_citations, cache=FALSE, include=FALSE}
write.bibtex(file = "knitcitations.bib")
```

<div id = "refs"></div>














###### TABLA 1

**Tabla 1**. Cada tabla debe aportar su correspondiente encabezamiento explicativo. En los Artículos de investigación, de revisión y Comunicaciones breves se aportarán los encabezamientos tanto en castellano como en inglés, en letra Arial 10 y en página independiente. Es importante que sean simples y que no superen el ancho una página DIN A4 vertical. Los originales se deben aportar en formato tabla y no en formato imagen. 

**Table 1**. Table heading in English. 

```{r Tabla1, results='asis', echo=FALSE, cache=FALSE}
library("knitr")
kable(head(iris))
```





###### PIES DE FIGURA

**Figura 1**. Pie de figura 1. 

**Figura 2**. Pie de figura 2.





###### FIGURE LEGENDS

**Figure 1**. Figure caption.

**Figure 2**. Figure caption.




###### FIGURA 1

```{r Fig1, echo=FALSE, fig.cap="Figura 1. Esto es un ejemplo.", cache=FALSE}
x <- rnorm(100)
y <- jitter(x, 1000)
plot(x, y)
```



###### FIGURA 2

```{r Fig2, echo=FALSE, fig.cap="Figura 2. Segundo ejemplo", cache=FALSE}
a <- sort(rnorm(100))
b <- c(rep("Group Small", 35), rep("Group Big", 65))
boxplot(a ~ b)
```









